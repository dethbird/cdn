{% extends 'layout.twig' %}

{% block title %}Personal CDN{% endblock %}

{% block content %}
  {% if upload_info is defined %}
    <div class="notification is-success">
      <strong>Upload received</strong>
      <div>Title: {{ upload_info.title|e }}</div>
      <div>Project: {{ upload_info.project|e }}</div>
      <div>Filename: {{ upload_info.filename|e }}</div>
      <div>Size: {{ upload_info.size is not null ? upload_info.size : 'unknown' }}</div>
      <div>Type: {{ upload_info.media_type|e }}</div>
    </div>
  {% endif %}
  {% if flash is defined and flash %}
    <div class="notification is-{{ flash.type == 'error' ? 'danger' : (flash.type == 'warning' ? 'warning' : 'success') }}">
      {{ flash.message|e }}
    </div>
  {% endif %}
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
      <div style="display:flex;gap:1rem;flex:1;align-items:center">
        <form method="get" class="field has-addons" style="flex:1;display:flex;align-items:center;gap:.5rem">
          <div class="control">
            <div class="select">
              <select id="projectFilterSelect" name="project">
                <option value="">Project (any)</option>
                {% for p in projects %}
                  <option value="{{ p.id|e }}" {% if p.id == project %}selected{% endif %}>{{ p.name|e }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="control">
            <div class="select">
              <select id="kindFilterSelect" name="kind">
                <option value="any" {% if kind == '' or kind == 'any' %}selected{% endif %}>Kind (any)</option>
                <option value="image" {% if kind == 'image' %}selected{% endif %}>Image</option>
                <option value="audio" {% if kind == 'audio' %}selected{% endif %}>Audio</option>
              </select>
            </div>
          </div>
          <div class="control is-expanded">
            <input class="input" name="q" placeholder="search title (case-insensitive)" value="{{ q|default('')|e }}" />
          </div>
          <div class="control">
            <button class="button is-info">Filter</button>
          </div>
          <div class="control">
            <a class="button is-light" href="/">Clear</a>
          </div>
        </form>
      </div>
      
    </div>
  </div>

  <script>
    // Submit the surrounding GET form when either select changes so Filter preserves all params
    const projectSelect = document.getElementById('projectFilterSelect')
    const kindSelect = document.getElementById('kindFilterSelect')
    if (projectSelect) projectSelect.addEventListener('change', function(){ this.form.submit() })
    if (kindSelect) kindSelect.addEventListener('change', function(){ this.form.submit() })
  </script>

  <div class="box">
    <div class="table-container">
  <table class="table is-fullwidth is-hoverable has-text-centered">
        <thead>
            <tr>
            <th class="has-text-centered">Kind</th>
            <th class="has-text-centered">Project</th>
            <th class="has-text-centered">
              {# sortable Title #}
              {% set newOrder = (sort == 'title' and order == 'asc') ? 'desc' : 'asc' %}
              <a href="?{% if project %}project={{ project|e }}&{% endif %}{% if kind %}kind={{ kind|e }}&{% endif %}{% if q %}q={{ q|e }}&{% endif %}sort=title&order={{ newOrder }}">Title
                {% if sort == 'title' %}
                  {{ order == 'asc' ? ' ▲' : ' ▼' }}
                {% endif %}
              </a>
            </th>
            <th class="has-text-centered">URL</th>
            <th class="has-text-centered">Renditions</th>
            <th class="has-text-centered">Metrics</th>
            <th class="has-text-centered">
              {# sortable Size #}
              {% set newOrder = (sort == 'size' and order == 'asc') ? 'desc' : 'asc' %}
              <a href="?{% if project %}project={{ project|e }}&{% endif %}{% if kind %}kind={{ kind|e }}&{% endif %}{% if q %}q={{ q|e }}&{% endif %}sort=size&order={{ newOrder }}">Size
                {% if sort == 'size' %}
                  {{ order == 'asc' ? ' ▲' : ' ▼' }}
                {% endif %}
              </a>
            </th>
            <th class="has-text-centered">
              {# sortable Created #}
              {% set newOrder = (sort == 'created' and order == 'asc') ? 'desc' : 'asc' %}
              <a href="?{% if project %}project={{ project|e }}&{% endif %}{% if kind %}kind={{ kind|e }}&{% endif %}{% if q %}q={{ q|e }}&{% endif %}sort=created&order={{ newOrder }}">Created
                {% if sort == 'created' %}
                  {{ order == 'asc' ? ' ▲' : ' ▼' }}
                {% endif %}
              </a>
            </th>
            <th class="has-text-centered">Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
            <tr>
              <td class="has-text-weight-semibold">{{ it.kind|e }}</td>
              <td>{{ it.project|e }}</td>
              <td>{{ it.title|e }}</td>
              <td class="url">
                {% if it.kind == 'image' %}
                  {% if it.url_1200 %}<div><a href="{{ it.url_1200|e }}" target="_blank">1200</a></div>{% endif %}
                  {% if it.url_800 %}<div><a href="{{ it.url_800|e }}" target="_blank">800</a></div>{% endif %}
                {% else %}
                  {% if it.kind == 'audio' %}
                    <a href="{{ it.url_main|e }}" target="_blank">mp3</a>
                  {% else %}
                    <a href="{{ it.url_main|e }}" target="_blank">{{ it.url_main|e }}</a>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if it.kind == 'image' and it.url_800 %}
                  <div style="margin-bottom:.5rem"><a href="{{ it.url_800|e }}" target="_blank"><img src="{{ it.url_800|e }}" alt="{{ it.title|e }}" style="max-width:150px;max-height:100px;object-fit:cover;border:1px solid #eee;padding:2px;background:#fff"/></a></div>
                {% elseif it.kind == 'audio' and it.url_main %}
                  <div>
                    <audio controls>
                      <source src="{{ it.url_main|e }}" />
                      Your browser does not support the audio element.
                    </audio>
                  </div>
                {% endif %}
              </td>
              <td>
                {% if it.kind == 'image' and it.width and it.height %}
                  {{ it.width }}x{{ it.height }}
                {% elseif it.kind == 'audio' and it.duration_sec is defined and it.duration_sec %}
                  {{ it.duration_sec|number_format(2, '.', '') }}s
                {% else %}
                  &nbsp;
                {% endif %}
              </td>
              <td>{{ it.size_human }}</td>
              <td>{{ it.created_at|date("F j, Y g:i:s") }}</td>
              <td>
                <div style="display:flex;gap:.5rem;justify-content:center;align-items:center">
                  <a class="button is-small" href="/media/{{ it.id|e }}/edit">Edit</a>
                  <form method="post" action="/media/{{ it.id|e }}/delete" onsubmit="return confirm('Delete media {{ it.id|e }}? This will remove files and database row.');" style="margin:0">
                    <button class="button is-small is-danger" type="submit">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
{% endblock %}
