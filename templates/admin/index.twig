{% extends 'layout.twig' %}

{% block title %}Personal CDN{% endblock %}

{% block content %}
  {% if upload_info is defined %}
    <div class="notification is-success">
      <strong>Upload received</strong>
      <div>Title: {{ upload_info.title|e }}</div>
      <div>Project: {{ upload_info.project|e }}</div>
      <div>Filename: {{ upload_info.filename|e }}</div>
      <div>Size: {{ upload_info.size is not null ? upload_info.size : 'unknown' }}</div>
      <div>Type: {{ upload_info.media_type|e }}</div>
    </div>
  {% endif %}
  {% if flash is defined and flash %}
    <div class="notification is-{{ flash.type == 'error' ? 'danger' : (flash.type == 'warning' ? 'warning' : 'success') }}">
      {{ flash.message|e }}
    </div>
  {% endif %}
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
      <div style="display:flex;gap:1rem;flex:1;align-items:center">
        <form method="get" class="field has-addons" style="flex:1;display:flex;align-items:center;gap:.5rem">
          <div class="control">
            <div class="select">
              <select id="projectFilterSelect" name="project">
                <option value="">Project (any)</option>
                {% for p in projects %}
                  <option value="{{ p.id|e }}" {% if p.id == project %}selected{% endif %}>{{ p.name|e }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="control">
            <div class="select">
              <select id="kindFilterSelect" name="kind">
                <option value="any" {% if kind == '' or kind == 'any' %}selected{% endif %}>Kind (any)</option>
                <option value="image" {% if kind == 'image' %}selected{% endif %}>Image</option>
                <option value="audio" {% if kind == 'audio' %}selected{% endif %}>Audio</option>
              </select>
            </div>
          </div>
          <div class="control is-expanded">
            <input class="input" name="q" placeholder="search title (case-insensitive)" value="{{ q|default('')|e }}" />
          </div>
          <div class="control">
            <div class="select">
              <select name="per_page" id="perPageSelect">
                {% for v in [5,15,25,50,100] %}
                  <option value="{{ v }}" {% if per_page is defined and per_page == v %}selected{% endif %}>{{ v }} per page</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="control">
            <button class="button is-info" title="Apply filters" aria-label="Apply filters" type="submit">
              <i class="fa-solid fa-filter" aria-hidden="true"></i>
            </button>
          </div>
          <div class="control">
            <a class="button is-light" href="/" title="Clear filters" aria-label="Clear filters">
              <i class="fa-solid fa-ban" aria-hidden="true"></i>
            </a>
          </div>
        </form>
      </div>
      
    </div>
  </div>




  <div class="box">
    <div class="table-container">
  <table class="table is-fullwidth is-hoverable has-text-centered">
        <thead>
            <tr>
            <th class="has-text-centered">Kind</th>
            <th class="has-text-centered">Project</th>
            <th class="has-text-centered">
              {# sortable Title #}
              {% set newOrder = (sort == 'title' and order == 'asc') ? 'desc' : 'asc' %}
              <a href="?{% if project %}project={{ project|e }}&{% endif %}{% if kind %}kind={{ kind|e }}&{% endif %}{% if q %}q={{ q|e }}&{% endif %}sort=title&order={{ newOrder }}">Title
                {% if sort == 'title' %}
                  {{ order == 'asc' ? ' ▲' : ' ▼' }}
                {% endif %}
              </a>
            </th>
            <th class="has-text-centered">URL</th>
            <th class="has-text-centered">Renditions</th>
            <th class="has-text-centered">Metrics</th>
            <th class="has-text-centered">
              {# sortable Size #}
              {% set newOrder = (sort == 'size' and order == 'asc') ? 'desc' : 'asc' %}
              <a href="?{% if project %}project={{ project|e }}&{% endif %}{% if kind %}kind={{ kind|e }}&{% endif %}{% if q %}q={{ q|e }}&{% endif %}sort=size&order={{ newOrder }}">Size
                {% if sort == 'size' %}
                  {{ order == 'asc' ? ' ▲' : ' ▼' }}
                {% endif %}
              </a>
            </th>
            <th class="has-text-centered">
              {# sortable Created #}
              {% set newOrder = (sort == 'created' and order == 'asc') ? 'desc' : 'asc' %}
              <a href="?{% if project %}project={{ project|e }}&{% endif %}{% if kind %}kind={{ kind|e }}&{% endif %}{% if q %}q={{ q|e }}&{% endif %}sort=created&order={{ newOrder }}">Created
                {% if sort == 'created' %}
                  {{ order == 'asc' ? ' ▲' : ' ▼' }}
                {% endif %}
              </a>
            </th>
            <th class="has-text-centered">Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
            <tr>
              <td class="has-text-weight-semibold">
                {% if it.kind == 'image' %}
                  <i class="fa-solid fa-image kind-icon" title="image" aria-hidden="true"></i>
                {% elseif it.kind == 'audio' %}
                  <i class="fa-solid fa-file-audio kind-icon audio" title="audio" aria-hidden="true"></i>
                {% else %}
                  {{ it.kind|e }}
                {% endif %}
              </td>
              <td>{{ it.project|e }}</td>
              <td>{{ it.title|e }}</td>
              <td class="url">
                {% if it.kind == 'image' %}
                  {% if it.url_1200 %}
                    <div>
                      <button type="button" class="button is-small copy-url-btn" data-url="{{ it.url_1200|e }}" title="Copy 1200 URL" aria-label="Copy 1200 URL">
                        <i class="fa-solid fa-copy" aria-hidden="true"></i>&nbsp;1200 url
                      </button>
                    </div>
                  {% endif %}
                  {% if it.url_800 %}
                    <div>
                      <button type="button" class="button is-small copy-url-btn" data-url="{{ it.url_800|e }}" title="Copy 800 URL" aria-label="Copy 800 URL">
                        <i class="fa-solid fa-copy" aria-hidden="true"></i>&nbsp;800 url
                      </button>
                    </div>
                  {% endif %}
                  {% if it.url_320 %}
                    <div>
                      <button type="button" class="button is-small copy-url-btn" data-url="{{ it.url_320|e }}" title="Copy 320 URL" aria-label="Copy 320 URL">
                        <i class="fa-solid fa-copy" aria-hidden="true"></i>&nbsp;320 url
                      </button>
                    </div>
                  {% endif %}
                {% else %}
                  {% if it.kind == 'audio' %}
                    <button type="button" class="button is-small copy-url-btn" data-url="{{ it.url_main|e }}" title="Copy mp3 URL" aria-label="Copy mp3 URL">
                      <i class="fa-solid fa-copy" aria-hidden="true"></i>&nbsp;mp3 url
                    </button>
                  {% else %}
                    {% if it.url_main %}
                      <button type="button" class="button is-small copy-url-btn" data-url="{{ it.url_main|e }}" title="Copy URL" aria-label="Copy URL">
                        <i class="fa-solid fa-copy" aria-hidden="true"></i>&nbsp;url
                      </button>
                    {% else %}
                      &nbsp;
                    {% endif %}
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if it.kind == 'image' and it.url_800 %}
                  <div style="margin-bottom:.5rem"><a href="{{ it.url_800|e }}" target="_blank"><img src="{{ it.url_800|e }}" alt="{{ it.title|e }}" style="max-width:150px;max-height:100px;object-fit:cover;border:1px solid #eee;padding:2px;background:#fff"/></a></div>
                {% elseif it.kind == 'audio' and it.url_main %}
                  <div>
                    <audio controls>
                      <source src="{{ it.url_main|e }}" />
                      Your browser does not support the audio element.
                    </audio>
                  </div>
                {% endif %}
              </td>
              <td class="is-size-7">
                {% if it.kind == 'image' and it.width and it.height %}
                  {{ it.width }}x{{ it.height }}
                {% elseif it.kind == 'audio' and it.duration_sec is defined and it.duration_sec %}
                  {{ it.duration_sec|number_format(2, '.', '') }}s
                {% else %}
                  &nbsp;
                {% endif %}
              </td>
              <td class="is-size-7">{{ it.size_human }}</td>
              <td class="is-size-7">{{ it.created_at|date("F j, Y g:i:s") }}</td>
              <td>
                <div style="display:flex;gap:.25rem;justify-content:center;align-items:center">
                  <a class="button is-small" href="/media/{{ it.id|e }}/edit" title="Edit" aria-label="Edit media {{ it.id|e }}">
                    <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                  </a>
                  <form method="post" action="/media/{{ it.id|e }}/delete" onsubmit="return confirm('Delete media {{ it.id|e }}? This will remove files and database row.');" style="margin:0">
                    <button class="button is-small is-danger" type="submit" title="Delete" aria-label="Delete media {{ it.id|e }}">
                      <i class="fa-solid fa-trash" aria-hidden="true"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  {# pagination UI (moved below table) #}
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        Page <strong>{{ page|default(1) }}</strong> of <strong>{{ total_pages|default(1) }}</strong> — total {{ total|default(0) }} items
      </div>
      <div>
        <div class="select">
          <select id="pageSelect">
            {% set tp = total_pages|default(1) %}
            {% for p in 1..tp %}
              <option value="{{ p }}" {% if page is defined and page == p %}selected{% endif %}>Page {{ p }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Submit the surrounding GET form when either select changes so Filter preserves all params
    const projectSelect = document.getElementById('projectFilterSelect')
    const kindSelect = document.getElementById('kindFilterSelect')
    if (projectSelect) projectSelect.addEventListener('change', function(){ this.form.submit() })
    if (kindSelect) kindSelect.addEventListener('change', function(){ this.form.submit() })
    // per-page select should submit the form as well
    const perPage = document.getElementById('perPageSelect')
    if (perPage) perPage.addEventListener('change', function(){ this.form.submit() })

    // page select: construct URL preserving project/kind/q/sort/order/per_page and navigate
    const pageSelect = document.getElementById('pageSelect')
    if (pageSelect) pageSelect.addEventListener('change', function(e){
      const p = e.target.value
      const url = new URL(window.location.href)
      url.searchParams.set('page', p)
      window.location = url.toString()
    })
  </script>

  <script>
    // clipboard copy buttons
    function fallbackCopyTextToClipboard(text) {
      const input = document.createElement('input')
      document.body.appendChild(input)
      input.value = text
      input.select()
      try { document.execCommand('copy') } catch(e) {}
      input.remove()
    }
    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text)
      }
      return new Promise(function(resolve){ fallbackCopyTextToClipboard(text); resolve(); })
    }

    // small aria-live region for screen readers
    let copyStatus = document.getElementById('copyStatus')
    if (!copyStatus) {
      copyStatus = document.createElement('div')
      copyStatus.id = 'copyStatus'
      copyStatus.setAttribute('aria-live','polite')
      copyStatus.style.position = 'absolute'
      copyStatus.style.left = '-9999px'
      copyStatus.style.width = '1px'
      copyStatus.style.height = '1px'
      copyStatus.style.overflow = 'hidden'
      document.body.appendChild(copyStatus)
    }

    document.querySelectorAll('.copy-url-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        let url = this.getAttribute('data-url') || ''
        if (!url) return
        // build an absolute URL: if url already has scheme, use as-is;
        // if it starts with '/', prepend origin; otherwise prepend origin + '/'
        let finalUrl = url
        try {
          if (/^https?:\/\//i.test(url)) {
            finalUrl = url
          } else if (/^\/\//.test(url)) {
            finalUrl = window.location.protocol + url
          } else if (url.startsWith('/')) {
            finalUrl = window.location.origin + url
          } else {
            // relative path; ensure single slash
            finalUrl = window.location.origin + '/' + url.replace(/^\/*/, '')
          }
        } catch (e) {
          finalUrl = url
        }

        // toggle icon to checkmark while keeping the label text
        const icon = this.querySelector('i')
        const hadIcon = !!icon
        const label = this.textContent.trim()
        copyText(finalUrl).then(()=>{
          if (hadIcon && icon) {
            icon.classList.remove('fa-copy')
            icon.classList.add('fa-check')
          }
          // announce to screen readers
          copyStatus.textContent = 'Copied URL'
          setTimeout(()=>{
            if (hadIcon && icon) {
              icon.classList.remove('fa-check')
              icon.classList.add('fa-copy')
            }
            copyStatus.textContent = ''
          }, 1500)
        })
      })
    })
  </script>
{% endblock %}
